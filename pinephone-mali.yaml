{{- $architecture := or .architecture "arm64" -}}

architecture: {{ $architecture }}
actions:
  - action: download
    description: Fetch mali blobs
    url: https://repo.kaidan.im/debpm/pool/non-free/m/mali-utgard-driver/mali-400-wayland-driver_6.2-1_arm64.deb
    name: mali
    filename: mali.dpkg

  - action: download
    description: Fetch mali driver
    url: https://gitlab.com/pine64-org/sunxi-mali/-/jobs/artifacts/ubports/download?job=build
    name: malidriver
    filename: malidriver.zip
    unpack: true
    compression: zip

  - action: overlay
    description: Copying mali driver to rootfs
    origin: malidriver
    source: .
    destination: /

  - action: overlay
    description: Coping mali to rootfs
    origin: mali
    source: .
    destination: /var/tmp/mali.deb

    # This needs to be done before update-initramfs (done by installing kernel with dpkg)
  - action: run
    chroot: true
    description: Disabling lima
    command: echo "blacklist lima" > /etc/modprobe.d/disable-lima.conf

  - action: run
    chroot: true
    description: Installing mali on rootfs
    label: dpkg
    command: dpkg --force-all -r libegl1-mesa libgbm1 libgles2-mesa libwayland-egl1-mesa libwayland-egl1 && dpkg -i -B /var/tmp/*.deb && rm /var/tmp/* -r

  - action: run
    chroot: true
    description: Setting egl libs to use mali
    script: scripts/enable-mali.sh
