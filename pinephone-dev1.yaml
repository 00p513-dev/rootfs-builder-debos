{{- $architecture := or .architecture "arm64" -}}
{{- $image := or .image "ubuntu-touch-pinephone-devboard1.img" -}}
{{- $variant := or .variant "mali" -}}

architecture: {{ $architecture }}
actions:
  - action: recipe
    description: Setup core rootfs
    recipe: mainline-rootfs-core.yaml
    varables:
      architecture: {{ $architecture }}

  - action: run
    description: Install firmwares
    script: scripts/wget-dpkg.sh http://mirrors.kernel.org/ubuntu/pool/main/l/linux-firmware/linux-firmware_1.181_all.deb

  - action: download
    description: Fetch latest kernel ci build
    url: https://gitlab.com/pine64-org/linux/-/jobs/artifacts/pine64-kernel-ubports/download?job=build
    name: kernel
    filename: kernel.zip
    unpack: true
    compression: zip

  - action: download
    description: Fetch u-boot build
    url: https://gitlab.com/pine64-org/u-boot/-/jobs/artifacts/master/download?job=build
    name: u-boot
    filename: build.zip
    unpack: true
    compression: zip

{{ if eq $variant "mali" }}
  - action: recipe
    description: Setting up mali
    recipe: pinephone-mali.yaml
    varables:
      architecture: {{ $architecture }}
{{end}}

  - action: overlay
    description: Copying kernel to rootfs
    origin: kernel
    source: .
    destination: /var/tmp/

  - action: run
    chroot: true
    description: Installing kernel on rootfs
    label: dpkg
    command: dpkg -i --force-all /var/tmp/*.deb && rm /var/tmp/* -r

  - action: run
    chroot: true
    script: scripts/try-depmod-installed.sh

#  - action: run
#    description: mkimage u-boot scr
#    command: mkimage -A arm -O linux -T script -C none -n "U-Boot boot script" -d pinephone-dev1/overlay/boot/boot.txt pinephone-dev1/overlay/boot/boot.scr

  - action: overlay
    source: pinephone-dev1/overlay
    destination: /

  - action: image-partition
    description: Creating image
    imagename: {{ $image }}
    imagesize: 4GB
    partitiontype: msdos
    mountpoints:
      - mountpoint: /
        partition: ROOTFS
    partitions:
      - name: ROOTFS
        fs: ext4
        start: 1M
        end: 100%
        flags: [ boot ]

  - action: filesystem-deploy
    description: Deploying filesystem into image

  - action: raw
    description: Installing bootloader
    origin: u-boot
    source: u-boot-sunxi-with-spl-sopine.bin
    offset: 8192

  - action: run
    description: Create bmap file
    postprocess: true
    command: bmaptool create {{ $image }} > {{ $image }}.bmap

  - action: run
    description: Compressing image
    postprocess: true
    command: pigz -f9 {{ $image }}
