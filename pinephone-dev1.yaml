{{- $architecture := or .architecture "arm64" -}}
{{- $image := or .image "ubuntu-touch-pinepone-devboard1.img" -}}

architecture: {{ $architecture }}
actions:
  - action: recipe
    description: Setup core rootfs
    recipe: mainline-rootfs-core.yaml
    varables:
      architecture: {{ $architecture }}

  - action: download
    description: Fetch latest kernel ci build
    url: https://gitlab.com/pine64-org/linux/-/jobs/artifacts/pine64-kernel/download?job=build
    name: kernel
    filename: kernel.zip
    unpack: true
    compression: zip

  - action: download
    description: Fetch u-boot build
    url: https://gitlab.com/pine64-org/u-boot/-/jobs/artifacts/master/download?job=build
    name: u-boot
    filename: build.zip
    unpack: true
    compression: zip

  - action: download
    description: Fetch mali blobs
    url: https://repo.kaidan.im/debpm/pool/non-free/m/mali-utgard-driver/mali-400-wayland-driver_6.2-1_arm64.deb
    name: mali
    filename: mali.dpkg

  - action: download
    description: Fetch mali driver
    url: https://gitlab.com/pine64-org/sunxi-mali/-/jobs/artifacts/master/download?job=build
    name: malidriver
    filename: malidriver.zip
    unpack: true
    compression: zip

  - action: overlay
    description: Copying kernel to rootfs
    origin: kernel
    source: .
    destination: /var/tmp/

  - action: overlay
    description: Copying mali driver to rootfs
    origin: malidriver
    source: .
    destination: /

  - action: overlay
    description: Coping mali to rootfs
    origin: mali
    source: .
    destination: /var/tmp/mali.deb

  - action: run
    chroot: true
    description: Installing kernel and mali on rootfs
    description: Install kernel
    label: dpkg
    command: dpkg -i --force-all /var/tmp/*.deb && rm /var/tmp/* -r

#  - action: run
#    description: mkimage u-boot scr
#    command: mkimage -A arm -O linux -T script -C none -n "U-Boot boot script" -d pinephone-dev1/overlay/boot/boot.txt pinephone-dev1/overlay/boot/boot.scr

  - action: overlay
    source: pinephone-dev1/overlay
    destination: /

  - action: image-partition
    description: Creating image
    imagename: {{ $image }}
    imagesize: 4GB
    partitiontype: msdos
    mountpoints:
      - mountpoint: /
        partition: ROOTFS
    partitions:
      - name: ROOTFS
        fs: ext4
        start: 1M
        end: 100%
        flags: [ boot ]

  - action: filesystem-deploy
    description: Deploying filesystem into image

  - action: raw
    description: Installing bootloader
    origin: u-boot
    source: u-boot-sunxi-with-spl-sopine.bin
    offset: 8192

  - action: run
    description: Create bmap file
    postprocess: true
    command: bmaptool create {{ $image }} > {{ $image }}.bmap

  - action: run
    description: Compressing image
    postprocess: true
    command: pigz -f9 {{ $image }}
